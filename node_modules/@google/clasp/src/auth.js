"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var utils_1 = require("./utils");
var dotfile_1 = require("./dotfile");
/**
 * Authentication with Google's APIs.
 */
var google_auth_library_1 = require("google-auth-library");
var googleapis_1 = require("googleapis");
var http_1 = __importDefault(require("http"));
var inquirer_1 = require("./inquirer");
var open_1 = __importDefault(require("open"));
var manifest_1 = require("./manifest");
var readline_1 = __importDefault(require("readline"));
var url_1 = __importDefault(require("url"));
// Auth is complicated. Consider yourself warned.
// tslint:disable:max-line-length
// GLOBAL: clasp login will store this (~/.clasprc.json):
// {
//   "access_token": "XXX",
//   "refresh_token": "1/k4rt_hgxbeGdaRag2TSVgnXgUrWcXwerPpvlzGG1peHVfzI58EZH0P25c7ykiRYd",
//   "scope": "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/script ...",
//   "token_type": "Bearer",
//   "expiry_date": 1539130731398
// }
// LOCAL: clasp login will store this (./.clasprc.json):
// {
//   "token": {
//     "access_token": "XXX",
//     "refresh_token": "1/k4rw_hgxbeGdaRag2TSVgnXgUrWcXwerPpvlzGG1peHVfzI58EZH0P25c7ykiRYd",
//     "scope": "https://www.googleapis.com/auth/script.projects https://www.googleapis.com/auth/script ...",
//     "token_type": "Bearer",
//     "expiry_date": 1539130731398
//   },
//   // Settings
//   "oauth2ClientSettings": {
//     "clientId": "807925367021-infvb16rd7lasqi22q2npeahkeodfrq5.apps.googleusercontent.com",
//     "clientSecret": "9dbdeOCRHUyriewCoDrLHtPg",
//     "redirectUri": "http://localhost"
//   },
//   "isLocalCreds": true
// }
// API settings
// @see https://developers.google.com/oauthplayground/
var REDIRECT_URI_OOB = 'urn:ietf:wg:oauth:2.0:oob';
var globalOauth2ClientSettings = {
    clientId: '1072944905499-vm2v2i5dvn0a0d2o4ca36i1vge8cvbn0.apps.googleusercontent.com',
    clientSecret: 'v6V3fKV_zWU7iw1DrpO1rknX',
    redirectUri: 'http://localhost',
};
var globalOAuth2Client = new google_auth_library_1.OAuth2Client(globalOauth2ClientSettings);
var localOAuth2Client; // Must be set up after authorize.
// *Global* Google API clients
exports.script = googleapis_1.google.script({ version: 'v1', auth: globalOAuth2Client });
exports.logger = googleapis_1.google.logging({ version: 'v2', auth: globalOAuth2Client });
exports.drive = googleapis_1.google.drive({ version: 'v3', auth: globalOAuth2Client });
exports.discovery = googleapis_1.google.discovery({ version: 'v1' });
exports.serviceUsage = googleapis_1.google.serviceusage({
    version: 'v1',
    auth: globalOAuth2Client,
});
/**
 * Gets the local OAuth client for the Google Apps Script API.
 * Only the Apps Script API needs to use local credential for the Execution API (script.run).
 * @see https://developers.google.com/apps-script/api/how-tos/execute
 */
function getLocalScript() {
    return __awaiter(this, void 0, void 0, function () {
        return __generator(this, function (_a) {
            return [2 /*return*/, googleapis_1.google.script({ version: 'v1', auth: localOAuth2Client })];
        });
    });
}
exports.getLocalScript = getLocalScript;
/**
 * Requests authorization to manage Apps Script projects.
 * @param {boolean} useLocalhost Uses a local HTTP server if true. Manual entry o.w.
 * @param {ClaspCredentials?} creds An optional credentials object.
 * @param {string[]} [scopes=[]] List of OAuth scopes to authorize.
 */
function authorize(options) {
    return __awaiter(this, void 0, void 0, function () {
        var oAuth2ClientOptions, localOAuth2ClientOptions, globalOauth2ClientOptions, scope, oAuth2ClientAuthUrlOpts, token, claspToken, dotfile, err_1;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 3, , 4]);
                    oAuth2ClientOptions = void 0;
                    if (options.creds) {
                        // if we passed our own creds
                        // Use local credentials
                        console.log(utils_1.LOG.CREDS_FROM_PROJECT(options.creds.installed.project_id));
                        localOAuth2ClientOptions = {
                            clientId: options.creds.installed.client_id,
                            clientSecret: options.creds.installed.client_secret,
                            redirectUri: options.creds.installed.redirect_uris[0],
                        };
                        oAuth2ClientOptions = localOAuth2ClientOptions;
                    }
                    else {
                        globalOauth2ClientOptions = {
                            clientId: '1072944905499-vm2v2i5dvn0a0d2o4ca36i1vge8cvbn0.apps.googleusercontent.com',
                            clientSecret: 'v6V3fKV_zWU7iw1DrpO1rknX',
                            redirectUri: 'http://localhost',
                        };
                        oAuth2ClientOptions = globalOauth2ClientOptions;
                    }
                    scope = (options.creds) ?
                        // Set scopes to custom scopes
                        options.scopes : [
                        // Default to clasp scopes
                        'https://www.googleapis.com/auth/script.deployments',
                        'https://www.googleapis.com/auth/script.projects',
                        'https://www.googleapis.com/auth/script.webapp.deploy',
                        'https://www.googleapis.com/auth/drive.metadata.readonly',
                        'https://www.googleapis.com/auth/drive.file',
                        'https://www.googleapis.com/auth/service.management',
                        'https://www.googleapis.com/auth/logging.read',
                        // Extra scope since service.management doesn't work alone
                        'https://www.googleapis.com/auth/cloud-platform',
                    ];
                    if (options.creds && scope.length === 0) {
                        scope = [
                            // Default to clasp scopes
                            'https://www.googleapis.com/auth/script.deployments',
                            'https://www.googleapis.com/auth/script.projects',
                            'https://www.googleapis.com/auth/script.webapp.deploy',
                            'https://www.googleapis.com/auth/drive.metadata.readonly',
                            'https://www.googleapis.com/auth/drive.file',
                            'https://www.googleapis.com/auth/service.management',
                            'https://www.googleapis.com/auth/logging.read',
                            // Extra scope since service.management doesn't work alone
                            'https://www.googleapis.com/auth/cloud-platform',
                        ];
                        // TODO formal error
                        // return logError(null, 'You need to specify scopes in the manifest.' +
                        // 'View appsscript.json. Add a list of scopes in "oauthScopes"' +
                        // 'Tip:' +
                        // '1. clasp open' +
                        // '2. File > Project Properties > Scopes');
                    }
                    oAuth2ClientAuthUrlOpts = {
                        access_type: 'offline',
                        scope: scope,
                    };
                    return [4 /*yield*/, (options.useLocalhost
                            ? authorizeWithLocalhost(oAuth2ClientOptions, oAuth2ClientAuthUrlOpts)
                            : authorizeWithoutLocalhost(oAuth2ClientOptions, oAuth2ClientAuthUrlOpts))];
                case 1:
                    token = _a.sent();
                    console.log(utils_1.LOG.AUTH_SUCCESSFUL + '\n');
                    claspToken = void 0;
                    dotfile = void 0;
                    if (options.creds) {
                        dotfile = dotfile_1.DOTFILE.RC_LOCAL();
                        // Save local ClaspCredentials.
                        claspToken = {
                            token: token,
                            oauth2ClientSettings: {
                                clientId: options.creds.installed.client_id,
                                clientSecret: options.creds.installed.client_secret,
                                redirectUri: options.creds.installed.redirect_uris[0],
                            },
                            isLocalCreds: true,
                        };
                    }
                    else {
                        dotfile = dotfile_1.DOTFILE.RC;
                        // Save global ClaspCredentials.
                        claspToken = {
                            token: token,
                            oauth2ClientSettings: globalOauth2ClientSettings,
                            isLocalCreds: false,
                        };
                    }
                    return [4 /*yield*/, dotfile.write(claspToken)];
                case 2:
                    _a.sent();
                    console.log(utils_1.LOG.SAVED_CREDS(!!options.creds));
                    return [3 /*break*/, 4];
                case 3:
                    err_1 = _a.sent();
                    utils_1.logError(null, utils_1.ERROR.ACCESS_TOKEN + err_1);
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    });
}
exports.authorize = authorize;
/**
 * Loads the Apps Script API credentials for the CLI.
 * Required before every API call.
 */
function loadAPICredentials(local) {
    if (local === void 0) { local = false; }
    return __awaiter(this, void 0, void 0, function () {
        var rc;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [4 /*yield*/, utils_1.getOAuthSettings(local)];
                case 1:
                    rc = _a.sent();
                    return [4 /*yield*/, setOauthClientCredentials(rc)];
                case 2:
                    _a.sent();
                    return [2 /*return*/, rc];
            }
        });
    });
}
exports.loadAPICredentials = loadAPICredentials;
/**
 * Requests authorization to manage Apps Script projects. Spins up
 * a temporary HTTP server to handle the auth redirect.
 * @param {OAuth2ClientOptions} oAuth2ClientOptions The required client options for auth
 * @param {GenerateAuthUrlOpts} oAuth2ClientAuthUrlOpts Auth URL options
 * Used for local/global testing.
 */
function authorizeWithLocalhost(oAuth2ClientOptions, oAuth2ClientAuthUrlOpts) {
    return __awaiter(this, void 0, void 0, function () {
        var server, port, client, authCode;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [4 /*yield*/, new Promise(function (resolve, _) {
                        var s = http_1.default.createServer();
                        s.listen(0, function () { return resolve(s); });
                    })];
                case 1:
                    server = _a.sent();
                    port = server.address().port;
                    client = new google_auth_library_1.OAuth2Client(__assign({}, oAuth2ClientOptions, { redirectUri: "http://localhost:" + port }));
                    return [4 /*yield*/, new Promise(function (res, rej) {
                            server.on('request', function (req, resp) {
                                var urlParts = url_1.default.parse(req.url || '', true);
                                if (urlParts.query.code) {
                                    res(urlParts.query.code);
                                }
                                else {
                                    rej(urlParts.query.error);
                                }
                                resp.end(utils_1.LOG.AUTH_PAGE_SUCCESSFUL);
                            });
                            var authUrl = client.generateAuthUrl(oAuth2ClientAuthUrlOpts);
                            console.log(utils_1.LOG.AUTHORIZE(authUrl));
                            open_1.default(authUrl);
                        })];
                case 2:
                    authCode = _a.sent();
                    server.close();
                    return [4 /*yield*/, client.getToken(authCode)];
                case 3: return [2 /*return*/, (_a.sent()).tokens];
            }
        });
    });
}
/**
 * Requests authorization to manage Apps Script projects. Requires the user to
 * manually copy/paste the authorization code. No HTTP server is used.
 * @param {OAuth2ClientOptions} oAuth2ClientOptions The required client options for auth.
 * @param {GenerateAuthUrlOpts} oAuth2ClientAuthUrlOpts Auth URL options
 */
function authorizeWithoutLocalhost(oAuth2ClientOptions, oAuth2ClientAuthUrlOpts) {
    return __awaiter(this, void 0, void 0, function () {
        var client, authUrl, authCode;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    client = new google_auth_library_1.OAuth2Client(__assign({}, oAuth2ClientOptions, { redirectUri: REDIRECT_URI_OOB }));
                    authUrl = client.generateAuthUrl(oAuth2ClientAuthUrlOpts);
                    console.log(utils_1.LOG.AUTHORIZE(authUrl));
                    return [4 /*yield*/, new Promise(function (res, rej) {
                            var rl = readline_1.default.createInterface({
                                input: process.stdin,
                                output: process.stdout,
                            });
                            rl.question(utils_1.LOG.AUTH_CODE, function (code) {
                                if (code && code.length) {
                                    res(code);
                                }
                                else {
                                    rej('No authorization code entered.');
                                }
                                rl.close();
                            });
                        })];
                case 1:
                    authCode = _a.sent();
                    return [4 /*yield*/, client.getToken(authCode)];
                case 2: return [2 /*return*/, (_a.sent()).tokens];
            }
        });
    });
}
/**
 * Set OAuth client credentails from rc.
 * Can be global or local.
 * Saves new credentials if access token refreshed.
 * @param {ClaspToken} rc OAuth client settings from rc file.
 */
function setOauthClientCredentials(rc) {
    return __awaiter(this, void 0, void 0, function () {
        /**
         * Refreshes the credentials and saves them.
         */
        function refreshCredentials(oAuthClient) {
            return __awaiter(this, void 0, void 0, function () {
                var oldExpiry;
                return __generator(this, function (_a) {
                    switch (_a.label) {
                        case 0:
                            oldExpiry = oAuthClient.credentials.expiry_date || 0;
                            return [4 /*yield*/, oAuthClient.getAccessToken()];
                        case 1:
                            _a.sent(); // refreshes expiry date if required
                            if (oAuthClient.credentials.expiry_date === oldExpiry)
                                return [2 /*return*/];
                            rc.token = oAuthClient.credentials;
                            return [2 /*return*/];
                    }
                });
            });
        }
        var err_2;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 6, , 7]);
                    return [4 /*yield*/, utils_1.checkIfOnline()];
                case 1:
                    _a.sent();
                    if (!rc.isLocalCreds) return [3 /*break*/, 3];
                    localOAuth2Client = new google_auth_library_1.OAuth2Client({
                        clientId: rc.oauth2ClientSettings.clientId,
                        clientSecret: rc.oauth2ClientSettings.clientSecret,
                        redirectUri: rc.oauth2ClientSettings.redirectUri,
                    });
                    localOAuth2Client.setCredentials(rc.token);
                    return [4 /*yield*/, refreshCredentials(localOAuth2Client)];
                case 2:
                    _a.sent();
                    _a.label = 3;
                case 3:
                    // Always use the global credentials too for non-run functions.
                    globalOAuth2Client.setCredentials(rc.token);
                    return [4 /*yield*/, refreshCredentials(globalOAuth2Client)];
                case 4:
                    _a.sent();
                    // Save the credentials.
                    return [4 /*yield*/, (rc.isLocalCreds ? dotfile_1.DOTFILE.RC_LOCAL() : dotfile_1.DOTFILE.RC).write(rc)];
                case 5:
                    // Save the credentials.
                    _a.sent();
                    return [3 /*break*/, 7];
                case 6:
                    err_2 = _a.sent();
                    utils_1.logError(null, utils_1.ERROR.ACCESS_TOKEN + err_2);
                    return [3 /*break*/, 7];
                case 7: return [2 /*return*/];
            }
        });
    });
}
/**
 * Compare global OAuth client scopes against manifest and prompt user to
 * authorize if new scopes found (local OAuth credentails only).
 * @param {ClaspToken} rc OAuth client settings from rc file.
 */
// TODO: currently unused. Check relevancy
function checkOauthScopes(rc) {
    return __awaiter(this, void 0, void 0, function () {
        var scopes_1, oauthScopes, newScopes_1, err_3;
        var _this = this;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 6, , 7]);
                    return [4 /*yield*/, utils_1.checkIfOnline()];
                case 1:
                    _a.sent();
                    return [4 /*yield*/, setOauthClientCredentials(rc)];
                case 2:
                    _a.sent();
                    return [4 /*yield*/, globalOAuth2Client.getTokenInfo(globalOAuth2Client.credentials
                            .access_token)];
                case 3:
                    scopes_1 = (_a.sent()).scopes;
                    return [4 /*yield*/, manifest_1.readManifest()];
                case 4:
                    oauthScopes = (_a.sent()).oauthScopes;
                    newScopes_1 = oauthScopes && oauthScopes.length ? (oauthScopes).filter(function (x) { return !scopes_1.includes(x); }) : [];
                    if (!newScopes_1.length)
                        return [2 /*return*/];
                    console.log('New authoization scopes detected in manifest:\n', newScopes_1);
                    return [4 /*yield*/, inquirer_1.oauthScopesPrompt()
                            .then(function (answers) { return __awaiter(_this, void 0, void 0, function () {
                            return __generator(this, function (_a) {
                                switch (_a.label) {
                                    case 0:
                                        if (!answers.doAuth) return [3 /*break*/, 2];
                                        if (!rc.isLocalCreds)
                                            return [2 /*return*/, utils_1.logError(null, utils_1.ERROR.NO_LOCAL_CREDENTIALS)];
                                        return [4 /*yield*/, authorize({
                                                useLocalhost: answers.localhost,
                                                scopes: newScopes_1,
                                            })];
                                    case 1:
                                        _a.sent();
                                        _a.label = 2;
                                    case 2: return [2 /*return*/];
                                }
                            });
                        }); })];
                case 5:
                    _a.sent();
                    return [3 /*break*/, 7];
                case 6:
                    err_3 = _a.sent();
                    utils_1.logError(null, utils_1.ERROR.BAD_REQUEST(err_3.message));
                    return [3 /*break*/, 7];
                case 7: return [2 /*return*/];
            }
        });
    });
}
exports.checkOauthScopes = checkOauthScopes;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImF1dGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsaUNBQWtHO0FBQ2xHLHFDQUF5RDtBQUN6RDs7R0FFRztBQUNILDJEQUEwRztBQUMxRyx5Q0FBK0M7QUFJL0MsOENBQXdCO0FBQ3hCLHVDQUErQztBQUMvQyw4Q0FBd0I7QUFDeEIsdUNBQTBDO0FBQzFDLHNEQUFnQztBQUNoQyw0Q0FBc0I7QUFFdEIsaURBQWlEO0FBQ2pELGlDQUFpQztBQUNqQyx5REFBeUQ7QUFDekQsSUFBSTtBQUNKLDJCQUEyQjtBQUMzQiwyRkFBMkY7QUFDM0YsMkdBQTJHO0FBQzNHLDRCQUE0QjtBQUM1QixpQ0FBaUM7QUFDakMsSUFBSTtBQUNKLHdEQUF3RDtBQUN4RCxJQUFJO0FBQ0osZUFBZTtBQUNmLDZCQUE2QjtBQUM3Qiw2RkFBNkY7QUFDN0YsNkdBQTZHO0FBQzdHLDhCQUE4QjtBQUM5QixtQ0FBbUM7QUFDbkMsT0FBTztBQUNQLGdCQUFnQjtBQUNoQiw4QkFBOEI7QUFDOUIsOEZBQThGO0FBQzlGLGtEQUFrRDtBQUNsRCx3Q0FBd0M7QUFDeEMsT0FBTztBQUNQLHlCQUF5QjtBQUN6QixJQUFJO0FBQ0osZUFBZTtBQUNmLHNEQUFzRDtBQUN0RCxJQUFNLGdCQUFnQixHQUFHLDJCQUEyQixDQUFDO0FBQ3JELElBQU0sMEJBQTBCLEdBQXdCO0lBQ3RELFFBQVEsRUFBRSwyRUFBMkU7SUFDckYsWUFBWSxFQUFFLDBCQUEwQjtJQUN4QyxXQUFXLEVBQUUsa0JBQWtCO0NBQ2hDLENBQUM7QUFDRixJQUFNLGtCQUFrQixHQUFHLElBQUksa0NBQVksQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBQ3hFLElBQUksaUJBQStCLENBQUMsQ0FBQyxrQ0FBa0M7QUFFdkUsOEJBQThCO0FBQ2pCLFFBQUEsTUFBTSxHQUFHLG1C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